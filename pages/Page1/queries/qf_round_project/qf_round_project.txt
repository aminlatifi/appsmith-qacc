WITH
	PROJECT_ROUND_COLLECTED AS (
		SELECT
			PROJECT.TITLE,
			QF_ROUND.TITLE as QF_ROUND_TITLE,
			SUM(AMOUNT) as "amount",
			SUM(COALESCE("valueUsd", 0)) as "valueUsd",
			DONATION."qfRoundId"
		FROM
			PUBLIC."donation" AS DONATION
		INNER JOIN PUBLIC.QF_ROUND ON DONATION."qfRoundId" = QF_ROUND.ID
		INNER JOIN PUBLIC.PROJECT ON DONATION."projectId" = PROJECT.ID
		WHERE
			donation.status = 'verified'
		GROUP BY
			PROJECT."title", QF_ROUND."title", DONATION."qfRoundId"
		ORDER BY
			PROJECT.TITLE
	),
	
	PROJECT_COLLECTED AS (
		SELECT
			TITLE,
			REGEXP_REPLACE(
				TO_CHAR(SUM(AMOUNT), 'FM999,999,999,990.00'),
				'\.?0+$',
				''
			) AS TOTAL_COLLECTED,
			REGEXP_REPLACE(
				TO_CHAR(
					SUM(COALESCE("valueUsd", 0)),
					'FM999,999,999,990.00'
				),
				'\.?0+$',
				''
			) AS TOTAL_USD_COLLECTED
		FROM
			PROJECT_ROUND_COLLECTED
		GROUP BY
			TITLE
	),
	
	PROJECT_SUPPORTERS AS (
		SELECT
			PROJECT.TITLE,
			COUNT(DISTINCT (DONATION."userId"))
		FROM
			PUBLIC."donation" AS DONATION
		INNER JOIN PUBLIC.QF_ROUND ON DONATION."qfRoundId" = QF_ROUND.ID
		INNER JOIN PUBLIC.PROJECT ON DONATION."projectId" = PROJECT.ID
		WHERE
			donation.status = 'verified'
		GROUP BY
			PROJECT."title"
		ORDER BY
			PROJECT.TITLE
	),

	ROUND_1_TOTAL AS (
		SELECT
			PROJECT.TITLE,
			REGEXP_REPLACE(
				TO_CHAR(SUM(AMOUNT), 'FM999,999,999,990.00'),
				'\.?0+$',
				''
			) AS ROUND_1_TOTAL_COLLECTED,
			REGEXP_REPLACE(
				TO_CHAR(
					SUM(COALESCE("valueUsd", 0)),
					'FM999,999,999,990.00'
				),
				'\.?0+$',
				''
			) AS ROUND_1_TOTAL_USD_COLLECTED
		FROM
			PUBLIC."donation" AS DONATION
		INNER JOIN PUBLIC.QF_ROUND ON DONATION."qfRoundId" = QF_ROUND.ID
		INNER JOIN PUBLIC.PROJECT ON DONATION."projectId" = PROJECT.ID
		WHERE
			DONATION."qfRoundId" = 2
			AND DONATION.status = 'verified'
		GROUP BY
			PROJECT.TITLE
	),

	ROUND_2_TOTAL AS (
		SELECT
			PROJECT.TITLE,
			REGEXP_REPLACE(
				TO_CHAR(SUM(AMOUNT), 'FM999,999,999,990.00'),
				'\.?0+$',
				''
			) AS ROUND_2_TOTAL_COLLECTED,
			REGEXP_REPLACE(
				TO_CHAR(
					SUM(COALESCE("valueUsd", 0)),
					'FM999,999,999,990.00'
				),
				'\.?0+$',
				''
			) AS ROUND_2_TOTAL_USD_COLLECTED
		FROM
			PUBLIC."donation" AS DONATION
		INNER JOIN PUBLIC.QF_ROUND ON DONATION."qfRoundId" = QF_ROUND.ID
		INNER JOIN PUBLIC.PROJECT ON DONATION."projectId" = PROJECT.ID
		WHERE
			DONATION."qfRoundId" = 4
			AND DONATION.status = 'verified'
		GROUP BY
			PROJECT.TITLE
	)

SELECT
	PROJECT_COLLECTED.*,
	PROJECT_SUPPORTERS.*,
	coalesce(ROUND_1_TOTAL.ROUND_1_TOTAL_COLLECTED, '0') as ROUND_1_TOTAL_COLLECTED,
	coalesce(ROUND_1_TOTAL.ROUND_1_TOTAL_USD_COLLECTED, '0') as ROUND_1_TOTAL_USD_COLLECTED,
	coalesce(ROUND_2_TOTAL.ROUND_2_TOTAL_COLLECTED, '0') as ROUND_2_TOTAL_COLLECTED,
	coalesce(ROUND_2_TOTAL.ROUND_2_TOTAL_USD_COLLECTED, '0') as ROUND_2_TOTAL_USD_COLLECTED
FROM
	PROJECT_COLLECTED
	INNER JOIN PROJECT_SUPPORTERS ON PROJECT_COLLECTED.TITLE = PROJECT_SUPPORTERS.TITLE
	LEFT JOIN ROUND_1_TOTAL ON PROJECT_COLLECTED.TITLE = ROUND_1_TOTAL.TITLE
	LEFT JOIN ROUND_2_TOTAL ON PROJECT_COLLECTED.TITLE = ROUND_2_TOTAL.TITLE;
